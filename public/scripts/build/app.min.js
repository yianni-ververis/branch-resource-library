var markedRenderer=new marked.Renderer;markedRenderer.image=function(a,b,c){var d='<img src="'+a+'"';if(null!=c&&""!=c&&(d+=' alt="'+c+'"'),null!=b&&""!=b)if(b.indexOf("x")>=0){var e=b.split("x");2!=e.length||isNaN(e[0])||isNaN(e[1])||(d+=' width="'+e[0]+'" height="'+e[1]+'"')}else isNaN(b)||(d+=' width="'+b+'"');return d+=" />"},markedRenderer.iframe=function(a){return'<iframe frameborder="0" allowfullscreen src="'+a+'"></iframe>'},marked.setOptions({renderer:markedRenderer});var app=angular.module("branch",["ui.router","ngResource","ngConfirm","ngNotifications","ngComments","ngModeration","ngRating","ngSubscribe","ngSanitize","vcRecaptcha"]);app.config(["$stateProvider","$urlRouterProvider","confirmConfigProvider","notificationConfigProvider","commentsConfigProvider","moderationConfigProvider","ratingConfigProvider","subscribeConfigProvider","$locationProvider",function(a,b,c,d,e,f,g,h,i){b.otherwise(function(a,b){return"#%2F"===b.$$url.substr(0,4)?b.$$hash:"/"}),a.state("home",{url:"/",templateUrl:"/views/home/index.html",controller:"homeController"}).state("tnc",{url:"/tnc",templateUrl:"/views/tnc/index.html"}).state("noitem",{url:"/noitem",templateUrl:"/views/noitem.html"}).state("badbrowser",{url:"/badbrowser",templateUrl:"/views/badbrowser.html"}).state("loginsignup",{url:"/loginsignup?url",templateUrl:"/views/loginsignup.html",controller:"authController"}).state("login",{url:"/login?url",templateUrl:"/views/login.html",controller:"authController"}).state("reset",{url:"/reset",templateUrl:"/views/reset.html",controller:"authController"}).state("admin",{url:"/shouldntbeabletoguessthisurl",templateUrl:"/views/admin/index.html",controller:"adminController"}).state("moderator",{url:"/moderator",templateUrl:"/views/moderator/index.html",controller:"moderatorController"}).state("projects",{url:"/project?terms&page&sort",templateUrl:"/views/projects/index.html",controller:"projectController"}).state("projects.detail",{url:"/:projectId?status",views:{"@":{templateUrl:"/views/projects/detail.html",controller:"projectController"}}}).state("projects.addedit",{url:"/:projectId/edit",views:{"@":{templateUrl:"/views/projects/addedit.html",controller:"projectController"}}}).state("publications",{url:"/blog",templateUrl:"/views/publications/index.html",controller:"publicationController"}).state("publications.redirect",{url:"/:publicationId?status",views:{"@":{templateUrl:"/views/publications/index.html",controller:"publicationController"}}}).state("rc",{url:"/resource",templateUrl:"/views/resourcecenter/index.html",controller:"resourceController"}).state("rc.detail",{url:"/:resourceId?status",views:{"@":{templateUrl:"/views/resourcecenter/detail.html",controller:"resourceController"}}}).state("rc.addedit",{url:"/:resourceId/edit",views:{"@":{templateUrl:"/views/resourcecenter/addedit.html",controller:"resourceController"}}}).state("users",{url:"/user?sort",templateUrl:"/views/users/index.html",controller:"userController"}).state("users.changepassword",{url:"/changepassword",views:{"@":{templateUrl:"/views/users/changepassword.html",controller:"userController"}}}).state("users.detail",{url:"/:userId",views:{"@":{templateUrl:"/views/users/detail.html",controller:"userController"}}}).state("users.addedit",{url:"/:userId/edit",views:{"@":{templateUrl:"/views/users/addedit.html",controller:"userController"}}}).state("userprofiles",{url:"/userprofile?sort",templateUrl:"/views/users/index.html",controller:"userController"}).state("userprofiles.addedit",{url:"/:userId/edit",views:{"@":{templateUrl:"/views/users/addedit.html",controller:"userController"}}}),i.hashPrefix("!")}]),app.run(["$rootScope","$location","$window",function(a,b,c){c.ga("create","UA-87754759-1","auto"),a.$on("$stateChangeSuccess",function(){c.ga("send","pageview",b.path()),document.body.scrollTop=document.documentElement.scrollTop=0})}]),window.WebSocket||(window.location="#!badbrowser"),app.directive("header",["userManager","$state","$interpolate",function(a,b,c){return{restrict:"A",replace:!0,scope:{},templateUrl:"/views/header.html",controller:["$scope",function(c){c.userManager=a,c.breadcrumb,c.$on("$stateChangeStart",function(){c.breadcrumb=null}),c.$on("setCrumb",function(a,b){c.breadcrumb=b}),$("#navbar").on("click","li a",null,function(){$(this).hasClass("dropdown-toggle")||$("#navbar").collapse("hide")}),c.getLoginUrl=function(){var a="";return"home"!=b.$current.name&&(a+="?url="),window.location.hash.indexOf("login")==-1&&window.location.hash.indexOf("reset")==-1&&(a+=window.location.hash.replace("#!/","")),"#!loginsignup"+a}}]}}]),app.directive("footer",["userManager","$state","$interpolate",function(a,b,c){return{restrict:"A",replace:!0,scope:{},templateUrl:"/views/footer.html",controller:["$scope",function(b){b.userManager=a,b.breadcrumb,b.$on("$stateChangeStart",function(){b.breadcrumb=null})}]}}]),app.directive("branchtree",["$interval",function(a){return{restrict:"E",replace:!0,scope:{width:"@",height:"@"},controller:["$scope","$element",function(b,c){function d(a){var b,c,f=e(a);n.push(a),a.d!==s&&(b=r*Math.random()-.5*r,c={i:n.length,x:f.x,y:f.y,a:a.a-p+b,l:a.l*q,d:a.d+1,parent:a.i},d(c),b=r*Math.random()-.5*r,c={i:n.length,x:f.x,y:f.y,a:a.a+p+b,l:a.l*q,d:a.d+1,parent:a.i},d(c))}function e(a){var b=a.x+a.l*Math.sin(a.a),c=a.y-a.l*Math.cos(a.a);return{x:b,y:c}}function f(a){return a.x}function g(a){return a.y}function h(a){return e(a).x}function i(a){return e(a).y}function j(){n=[],d(o),t.selectAll("line").data(n).enter().append("line").style("stroke","#8A8A8A").style("opacity",.6).style("stroke-width",function(a){return parseInt(s+1-a.d)+"px"}).attr("id",function(a){return"id-"+a.i}).transition().duration(500).delay(function(a,b){return 10*b}).attr("x1",f).attr("y1",g).attr("x2",h).attr("y2",i),k=a(u,4e3,30)}var k,l=b.width,m=b.height,n=[],o={i:0,x:l/2,y:m,a:0,l:70,d:0},p=.6,q=.8,r=.4,s=6,t=d3.select(c[0]).append("svg").attr("width",l).attr("height",m),u=function(){n=[],d(o),t.selectAll("line").data(n).transition().duration(2500).attr("x1",f).attr("y1",g).attr("x2",h).attr("y2",i)};j(),b.$on("$destroy",function(){b.$destroy(),b=null,a.cancel(k),c.remove(),c=null,u=null})}]}}]),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngConfirm",[]);return c.provider("confirmConfig",function(){return{$get:function(){return{}}}}),c.factory("confirm",["$rootScope",function(a){return{prompt:function(b,c,d){a.$broadcast("confirmPrompt",{message:b,options:c,callbackFn:d})}}}]),c.directive("confirmDialog",["confirmConfig","$timeout",function(a,b){return{restrict:"E",scope:{},template:function(a,b){return html="<div class='confirm-smokescreen' ng-class='{active:active==true, wide:options.requireComment==true}'>",html+="<div class='confirm-dialog'>",html+="<p>{{message}}</p>",html+="<textarea class='form-control' ng-model='comment' ng-if='options.requireComment'></textarea>",html+="<ul>",html+="<li ng-repeat='option in options.options'><button class='branch-button' ng-click='returnOption($index)'>{{option}}</button></li>",html+="</ul>",html+="</div>",html+="</div>",html},controller:["$scope",function(a){a.$on("confirmPrompt",function(b,c){a.message=c.message,a.options=c.options,a.callback=c.callbackFn,a.active=!0}),a.returnOption=function(b){var c=$(".confirm-dialog textarea").val();a.message=null,a.options=null,a.active=!1,a.callback.call(null,{result:b,comment:c})}}]}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngNotifications",[]);return c.provider("notificationConfig",function(){return{$get:function(){return{}}}}),c.factory("notifications",["$rootScope",function(a){return{notify:function(b,c,d){a.$broadcast("notify",{message:b,list:c,options:d})}}}]),c.directive("notificationDialog",["notificationConfig","$timeout",function(a,b){return{restrict:"E",scope:{},template:function(a,b){return html="<div ng-show='showing' class='{{options.sentiment}} col-md-12 notifications'>",html+="<p>{{message}}</p>",html+="<ul ng-if='list.length>0'>",html+="<li ng-repeat='item in list'>",html+="{{item}}",html+="</li>",html+="</ul>",html+="</div>",html},controller:["$scope",function(a){a.$on("notify",function(b,c){a.showing=!0,a.message=c.message||"",a.list=c.list||[],a.options=c.options||{}})}]}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngComments",[]);return c.provider("commentsConfig",function(){return{$get:function(){return{}}}}),c.factory("comments",["$rootScope",function(a){return{}}]),c.directive("comments",["commentsConfig","$timeout",function(a,b){return{restrict:"A",scope:{entity:"=",entityid:"=",parent:"="},templateUrl:"/views/comments.html",link:["$scope",function(a){}],controller:"commentController"}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngModeration",[]);return c.provider("moderationConfig",function(){return{$get:function(){return{}}}}),c.factory("moderation",["$rootScope",function(a){return{}}]),c.directive("moderation",["moderationConfig","$timeout",function(a,b){return{restrict:"E",replace:!0,scope:{entity:"=",entityid:"=",owner:"=",approved:"=",flagged:"=",flagcount:"=",editable:"=",download:"=",size:"=",orientation:"=",entityObject:"="},templateUrl:"/views/moderation.html",controller:"moderationController"}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngRating",[]);return c.provider("ratingConfig",function(){return{$get:function(){return{}}}}),c.factory("rating",["$root$scope",function(a){return{}}]),c.directive("rating",["ratingConfig","$resource","$timeout","resultHandler",function(a,b,c,d){return{restrict:"E",replace:!0,scope:{entity:"=",entityid:"=",user:"=",mode:"=",displaystar:"=?"},templateUrl:"/views/rating.html",controller:["$scope",function(a){var c=b("/api/rating/:ratingId",{ratingId:"@ratingId"});a.$watch("user",function(b,c){a.user&&a.entityid&&"static"!=a.mode&&a.getRating()}),a.$watch("entityid",function(b,c){a.user&&a.entityid&&"static"!=a.mode&&a.getRating()}),a.stars=[1,2,3,4,5],a.displayStar,a.pointsMap={1:-2,2:-1,3:1,4:2,5:3},a.getStar=function(){return a.displaystar?Math.round(a.displaystar):a.myRating&&a.myRating.rating?Math.round(a.myRating.rating):null},a.setDisplayStar=function(b){"static"!=a.mode&&(a.displaystar=b)},a.clearDisplayStar=function(){"static"!=a.mode&&(a.displaystar=null)},a.getRating=function(){c.get({entityId:a.entityid,userid:a.user},function(b){d.process(b)&&(a.myRating=b.data[0]||{})})},a.rate=function(b){var e={};a.myRating&&a.myRating._id?(e.ratingId=a.myRating._id,a.myRating.entityId=a.entityid,a.myRating.rating=b,a.myRating.points=a.pointsMap[b]):a.myRating={entityId:a.entityid,rating:b,points:a.pointsMap[b]},c.save(e,a.myRating,function(b){d.process(b)&&(a.myRating=b)})}}]}}]),c}),function(a,b){"object"==typeof exports?module.exports=b(a,require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngConfirm=b(a,c)}):a.ngConfirm=b(a,a.angular)}(this,function(a,b){var c=b.module("ngSubscribe",[]);return c.provider("subscribeConfig",function(){return{$get:function(){return{}}}}),c.factory("subscribe",["$rootScope",function(a){return{}}]),c.directive("subscribe",["subscribeConfig","$resource","$timeout","resultHandler","notifications",function(a,b,c,d,e){return{restrict:"E",replace:!0,scope:{entity:"=",entityid:"=",user:"="},template:function(a,b){var c="<button class='button-outline' ng-show='user' ng-click='toggleSubscription()' ng-disabled='{{subscribing==true}}'><i class='fa fa-envelope-o'></i>{{buttonText}}</button>";return c},controller:["$scope",function(a){a.buttonText="Please wait...";var c=b("/api/subscription/:subId",{subId:"@subId"});a.$watch("user",function(b,c){a.user&&a.entityid&&a.setup()}),a.$watch("entityid",function(b,c){a.user&&a.entityid&&a.setup()}),a.setup=function(){c.get({entityId:a.entityid,userid:a.user},function(b){d.process(b)&&(a.subscription=b.data[0],a.subscription?a.buttonText="Unsubscribe":a.buttonText="Subscribe")})},a.toggleSubscription=function(){a.subscribing=!0,a.subscription?c["delete"]({subId:a.subscription._id},function(b){a.subscribing=!1,d.process(b)?(e.notify("You have successfully unsubscribed.",null,{sentiment:"positive"}),a.buttonText="Subscribe"):e.notify(b.errText,null,{sentiment:"negative"})}):c.save({entityId:a.entityid,userid:a.user},function(b){a.subscribing=!1,d.process(b)?(a.subscription=b,e.notify("You have successfully subscribed.",null,{sentiment:"positive"}),a.buttonText="Unsubscribe"):e.notify(b.errText,null,{sentiment:"negative"})})}}]}}]),c}),app.directive("searchInput",["$state","$interpolate","confirm",function(a,b,c){return{restrict:"E",replace:!0,$scope:{},templateUrl:"/views/search/search-input.html",controller:["$scope","$element","$attrs",function(a,b,d){$.ajax({type:"GET",dataType:"text",contentType:"application/json",url:"/configs/"+d.config+".json",success:function(b){function e(a,b){var c=a;if(b.toLowerCase().indexOf(c.toLowerCase())!=-1);else if(b.length>c.length)for(;b.toLowerCase().indexOf(c.toLowerCase())==-1;)c=c.split(" "),c.splice(0,1),c=c.join(" ");for(;c.length>=b.length&&c.toLowerCase()!=b.toLowerCase();)c=c.split(" "),c.splice(0,1),c=c.join(" ");var d=new RegExp(c,"i");return b.replace(d,"")}a.config=JSON.parse(b);var f=[16,27],g=[9,13,38,40,39,37,32,33,34],h={BACKSPACE:8,ESCAPE:27,TAB:9,ENTER:13,SHIFT:16,UP:38,DOWN:40,RIGHT:39,LEFT:37,DELETE:46,SPACE:32};a.searchText,a.searchTimeout=300,a.suggestTimeout=100,a.searchTimeoutFn,a.suggestTimeoutFn,a.suggesting=!1,a.activeSuggestion=0,a.cursorPosition=0,searchExchange.subscribe("cleared",d.view+".input",function(){a.searchText="",(el=document.getElementById("branch-search-input"))&&(el.value=""),a.cursorPosition=0,a.suggestions=[],a.suggesting=!1,a.activeSuggestion=0,a.ghostPart="",a.ghostQuery="",a.ghostDisplay="",setTimeout(function(){a.preSearch()},0)}),searchExchange.subscribe("reset",d.view+".input",function(){a.searchText="",(el=document.getElementById("branch-search-input"))&&(el.value=""),a.cursorPosition=0,a.suggestions=[],a.suggesting=!1,a.activeSuggestion=0,a.ghostPart="",a.ghostQuery="",a.ghostDisplay=""}),searchExchange.subscribe("suggestResults",d.view+".input",function(b,c){a.suggestions=c.qSuggestions,a.suggestions.splice(5,c.qSuggestions.length-4),a.showSuggestion()}),a.keyDown=function(b){if(b.keyCode==h.ESCAPE)return void a.hideSuggestion();if(b.keyCode==h.DOWN)a.showSuggestion();else if(b.keyCode==h.RIGHT)a.suggesting&&(b.preventDefault(),a.nextSuggestion());else if(b.keyCode==h.LEFT)a.suggesting&&(b.preventDefault(),a.prevSuggestion());else if(b.keyCode==h.ENTER||b.keyCode==h.TAB)a.suggesting&&(b.preventDefault(),a.acceptSuggestion());else if(b.keyCode==h.SPACE){if(5==a.searchText.split(" ").length)return c.prompt("I hate to break it to you but you can only search for 5 things. Must try harder!",{options:["Thanks, I accept this without question"]},function(a){}),b.preventDefault(),!1;if(1==a.searchText.split(" ").pop().length)return c.prompt("You'll need to search for something longer than '"+a.searchText.split(" ").pop()+"'",{options:["That makes sense."]},function(a){}),b.preventDefault(),!1;a.hideSuggestion()}else a.hideSuggestion()},a.keyUp=function(b){a.cursorPosition=b.target.selectionStart,f.indexOf(b.keyCode)==-1&&g.indexOf(b.keyCode)==-1&&(a.searchText&&a.searchText.length>0?a.searchText.split(" ").pop().length>1&&(a.preSearch(),a.preSuggest()):a.clear())},a.nextSuggestion=function(){a.activeSuggestion==a.suggestions.length-1?a.activeSuggestion=0:a.activeSuggestion++,a.drawGhost()},a.prevSuggestion=function(){0==a.activeSuggestion?a.activeSuggestion=a.suggestions.length-1:a.activeSuggestion--,a.drawGhost()},a.hideSuggestion=function(){a.suggesting=!1,a.activeSuggestion=0,a.ghostPart="",a.ghostQuery="",a.ghostDisplay=""},a.showSuggestion=function(){a.searchText&&a.searchText.length>1&&a.cursorPosition==a.searchText.length&&a.suggestions.length>0?(a.suggesting=!0,a.drawGhost()):(a.suggesting=!1,a.removeGhost())},a.setAndAccept=function(b){a.activeSuggestion=b,a.drawGhost(),a.acceptSuggestion()},a.acceptSuggestion=function(){a.searchText=a.ghostQuery,a.suggestions=[],a.hideSuggestion(),a.preSearch()},a.drawGhost=function(){a.ghostPart=e(a.searchText,a.suggestions[a.activeSuggestion].qValue),a.ghostQuery=a.searchText+a.ghostPart,a.ghostDisplay="<span style='color: transparent;'>"+a.searchText+"</span>"+a.ghostPart},a.removeGhost=function(){a.ghostPart=null,a.ghostQuery=null,a.ghostDisplay=null},a.preSuggest=function(){a.searchText.length>1&&a.cursorPosition==a.searchText.length&&(a.suggestTimeoutFn&&clearTimeout(a.suggestTimeoutFn),a.suggestTimeoutFn=setTimeout(function(){searchExchange.suggest(a.searchText,a.config.suggestFields||[])},a.suggestTimeout))},a.preSearch=function(){a.searchTimeoutFn&&clearTimeout(a.searchTimeoutFn),a.searchTimeoutFn=setTimeout(function(){searchExchange.search(a.searchText,a.config.searchFields||[])},a.searchTimeout)},a.clear=function(){searchExchange.clear()},searchExchange.subscribe("executeSearch",d.view+".input",function(){setTimeout(function(){a.searchText="",searchExchange.state&&searchExchange.state&&searchExchange.state.searchText&&(a.searchText=searchExchange.state.searchText,document.getElementById("branch-search-input").value=a.searchText),a.preSearch()},0)}),searchExchange.subscribe("update",d.view+".input",function(){a.searchText||searchExchange.state&&searchExchange.state.searchText&&(a.searchText=searchExchange.state.searchText)})}})}]}}]),app.directive("searchFilter",[function(){return{restrict:"E",replace:!0,scope:{},controller:["$scope","$element","$attrs",function(a,b,c){a.title=c.title,a.handle,a.items,a.toggleValue=function(b){a.$parent.toggleSelect(c.field,b)},a.$on("searchResults",function(){a.handle?a.render():a.postponed=function(){a.render()}}),a.$on("initialising",function(){a.loading=!0}),a.$on("initialised",function(){a.handle?a.render():a.postponed=function(){a.render()}}),searchExchange.subscribe("update",c("id"),function(b){setTimeout(function(){a.handle?a.render():a.postponed=function(){a.render()}},0)}),a.$on("cleared",function(){a.handle?a.render():a.postponed=function(){a.render()}}),a.render=function(){searchExchange.ask(a.handle,"GetLayout",[],function(b){var c=b.result.qLayout;searchExchange.ask(a.handle,"GetListObjectData",["/qListObjectDef",[{qTop:0,qLeft:0,qHeight:c.qListObject.qSize.qcy,qWidth:1}]],function(b){var c=b.result.qDataPages;a.items=c[0].qMatrix,a.$apply()})})},a.selectValue=function(b){searchExchange.ask(a.handle,"SelectListObjectValues",["/qListObjectDef",[b],!0],function(a){searchExchange.render()})},searchExchange.addFilter({id:$(b).$attrs("id"),field:c.field},function(b){a.handle=b.handle,a.postponed&&a.postponed.call(null)})}],templateUrl:"/views/search/search-filter.html"}}]),app.directive("searchResults",["$resource","$state","$stateParams","userManager","resultHandler","publisher",function(a,b,c,d,e,f){return{restrict:"E",replace:!0,scope:{},controller:["$scope","$element","$attrs",function(b,c,f){$.ajax({type:"GET",dataType:"text",contentType:"application/json",url:"/configs/"+f.config+".json",success:function(c){function g(a){setTimeout(function(){searchExchange.state&&searchExchange.state.sort&&(b.sort=searchExchange.state.sort),null!=searchExchange.state&&null!=searchExchange.state.page&&(b.pageTop=b.config.pagesize*searchExchange.state.page),b.handle?a?a.indexOf(b.handle)!=-1&&b.render():b.render():b.postponed=function(){a?a.indexOf(b.handle)!=-1&&b.render():b.render()}},100)}function h(a,c){for(var d=0;d<b.fields.length;d++){if(b.fields[d].dimension&&b.fields[d].dimension==a)return void 0!=c&&0==c?[d]:"["+d+"]";if(b.fields[d].label&&b.fields[d].label==a)return void 0!=c&&0==c?[d]:"["+d+"]"}return 0}function i(a,b){for(var c=0;c<a.options.length;c++)a.options[c].value==b.id?a.options[c].setAttribute("selected",""):a.options[c].removeAttribute("selected")}b.config=JSON.parse(c),b.template=b.config.template,b.fields=b.config.fields,b.qFields,b.sortOptions=b.config.sorting,b.sort=b.sortOptions[b.config.defaultSort],b.elemId=f.id;var j;b.config.entity&&(j=a("/api/"+b.config.entity+"/:id",{id:"@id"})),b.highlightText=function(a){if(searchExchange.state&&searchExchange.state.searchText){for(var b=searchExchange.state.searchText.split(" "),c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}return a},b.loading=!0,b.items=[],b.hidden=[],b.flagged={},b.stars=new Array(5),b.postponed,b.resultsTemplateCallback,b.pagingTemplateCallback,b.pageTop=0,b.pageBottom=b.config.pagesize,b.currentPage=1,b.pages=[],b.broadcast=function(a,c){b.$root.$broadcast(a,c)},b.getHidden=function(){j&&j.get({id:"hidden"},{limit:100},function(a){e.process(a)&&(b.hidden=a.data)})},b.getFlagged=function(){j&&j.get({id:"flagged"},{limit:100},function(a){if(e.process(a)&&a.data)for(var c=0;c<a.data.length;c++)b.flagged[a.data[c].entityId]=!0})},b.getHidden(),b.getFlagged(),b.isHidden=function(a){for(var c=0;c<b.hidden.length;c++)if(b.hidden[c]._id==a)return!0;return!1},b.isFlagged=function(a){if(b.flagged){for(var c=0;c<b.flagged.length;c++)if(b.flagged[c].entityId==a)return!0;return!1}return!1},searchExchange.subscribe("searching",f.view,function(){b.loading=!0,b.pageTop=0,(el=document.getElementById(f.id+"_loading"))&&(document.getElementById(f.id+"_loading").style.display="block"),(el=document.getElementById(f.id+"_list_container"))&&(document.getElementById(f.id+"_list_container").style.display="none"),(el=document.getElementById(f.id+"_no_results"))&&(document.getElementById(f.id+"_no_results").style.display="none")}),searchExchange.subscribe("noresults",f.view,function(a,c){b.renderEmpty()}),searchExchange.subscribe("update",f.view,function(a,b){g(a)}),searchExchange.subscribe("resume",f.view,function(a,b){g(a)}),b.showItem=function(a,b){return"True"==a||d.canApprove(b)},b.changePage=function(a){b.pageTop+=b.config.pagesize*a,b.render()},b.setPage=function(a){searchExchange.setStateAttr("page",a),b.pageTop=b.config.pagesize*a,b.render()},b.pageInRange=function(a){var c,d;return 1!=b.pages.length&&(b.currentPage<=2?(c=1,d=5):b.currentPage>=b.pages.length-2?(c=b.pages.length-5,d=b.pages.length):(c=b.currentPage-2,d=b.currentPage+2),a>=c&&a<=d)},b.render=function(){(el=$("#"+f.id).find("._list")[0])&&searchExchange.ask(b.handle,"GetLayout",[],function(a){var c=a.result.qLayout;b.qFields=c.qHyperCube.qDimensionInfo.concat(c.qHyperCube.qMeasureInfo),searchExchange.ask(b.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:b.pageTop,qLeft:0,qHeight:b.config.pagesize,qWidth:b.fields.length}]],function(a){var e=a.result.qDataPages,g=[],h=0;b.$apply(function(){b.loading=!1,b.pageTop=e[0].qArea.qTop,b.pageBottom=e[0].qArea.qTop+e[0].qArea.qHeight,b.currentPage=Math.ceil(b.pageBottom/b.config.pagesize),b.total=c.qHyperCube.qSize.qcy,b.pages=[];for(var a=1;a<Math.ceil(b.total/b.config.pagesize)+1;a++)b.pages.push(a);b.items=[];for(var j={},k={},l={},a=0;a<c.qHyperCube.qMeasureInfo.length;a++)k[c.qHyperCube.qMeasureInfo[a].qFallbackTitle]=c.qHyperCube.qMeasureInfo[a].qMax,l[c.qHyperCube.qMeasureInfo[a].qFallbackTitle]=c.qHyperCube.qMeasureInfo[a].qMin,j[c.qHyperCube.qMeasureInfo[a].qFallbackTitle]=c.qHyperCube.qGrandTotalRow[a].qNum;for(var a=0;a<e[0].qMatrix.length;a++){var m={};if(null==b.config.nullSuppressor||"-"!=e[0].qMatrix[a][b.config.nullSuppressor].qText){for(var n=0;n<e[0].qMatrix[a].length;n++)m[b.qFields[n].qFallbackTitle]=e[0].qMatrix[a][n].qText;if("-"!=m.rating){m.stars=[];for(var o=parseInt(m.rating),p=0;p<o;p++)m.stars.push(p)}m.hidden=b.isHidden(m[b.config.primaryKey]),m.hidden&&h++,g.push(m)}}var q=$("#"+f.id).find("._sort")[0];if(i(q,b.sort),h==g.length){if(!d.hasUser)return void b.renderEmpty();if(!d.canApprove(b.entity))return void b.renderEmpty()}if(g.length>0){b.loading=!1,b.items=g;var r=[];searchExchange.state&&searchExchange.state.searchText&&(r=searchExchange.state.searchText.split(" ")),$("#"+f.id).find("._count_label")[0].innerHTML="Showing "+(b.pageTop+1)+" - "+b.pageBottom+" of "+b.total+" results",b.resultsTemplate?$("#"+f.id).find("._list")[0].innerHTML=b.resultsTemplate.getHTML({items:g,terms:r,totals:j,max:k,min:l,bucket:b.$root.bucket}):b.resultsTemplateCallback=function(){$("#"+f.id).find("._list")[0].innerHTML=b.resultsTemplate.getHTML({items:g,terms:r,totals:j,max:k,min:l,bucket:b.$root.bucket})},b.pagingTemplate?$("#"+f.id).find("._paging")[0].innerHTML=b.pagingTemplate.getHTML({currentPage:b.currentPage,pages:b.pages}):b.pagingTemplateCallback=function(){$("#"+f.id).find("._paging")[0].innerHTML=b.pagingTemplate.getHTML({currentPage:b.currentPage,pages:b.pages})},$("#"+f.id).find("._list_container")[0].style.display="block",$("#"+f.id).find("._no_results")[0].style.display="none"}else b.loading=!1,$("#"+f.id).find("._list_container")[0].style.display="none",$("#"+f.id).find("._no_results")[0].style.display="block",b.items=[];$("#"+f.id).find("._loading")[0].style.display="none",c.qHyperCube.qSize.qcx<b.fields.length&&b.pageWidth()})})})},b.renderEmpty=function(){b.loading=!1,$("#"+f.id).find("._loading")[0].style.display="none",$("#"+f.id).find("._list_container")[0].style.display="none",$("#"+f.id).find("._no_results")[0].style.display="block",b.items=[]},b.pageWidth=function(){searchExchange.ask(b.handle,"GetLayout",[],function(a){var c=a.qLayout;b.qFields=c.qHyperCube.qDimensionInfo.concat(c.qHyperCube.qMeasureInfo),searchExchange.ask(b.handle,"GetHyperCubeData",["/qHyperCubeDef",[{qTop:b.pageTop,qLeft:10,qHeight:b.config.pagesize,qWidth:b.fields.length}]],function(a){var c=a.qDataPages;b.$apply(function(){c[0].qMatrix.map(function(a,c){for(var d=b.items[c],e=0;e<a.length;e++)d[b.qFields[e].qFallbackTitle]=a[e].qText;return d})})})})},b.applySort=function(a,c){searchExchange.setStateAttr("sort",a),searchExchange.ask(b.handle,"ApplyPatches",[[{qPath:"/qHyperCubeDef/qInterColumnSortOrder",qOp:"replace",qValue:h(a.field)}],!0],function(){c&&1==c&&b.render()})},b.$root.$on("$stateChangeStart",function(a,c,d,e,f){e.name.split(".")[0]==c.name.split(".")[0]&&1==c.name.split(".").length&&searchExchange.state&&searchExchange.state.sort&&b.applySort(searchExchange.state.sort)}),b.$root.$on("$stateChangeSuccess",function(a,b,c,d,e){1==b.name.split(".").length&&searchExchange.state&&(searchExchange.state.page||searchExchange.state.sort)&&searchExchange.render()}),searchExchange.addResults({id:f.id,fields:b.fields,sortOptions:b.sortOptions,defaultSort:h(b.sort.field,!1)},function(a){b.handle=a.handle,b.resultsTemplate||$.get(b.template).success(function(a){b.resultsTemplate=new Templater(a),b.resultsTemplateCallback&&(b.resultsTemplateCallback.call(),b.resultsTemplateCallback=null)}),b.pagingTemplate||$.get("/views/search/search-paging.html").success(function(a){b.pagingTemplate=new Templater(a),b.pagingTemplateCallback&&(b.pagingTemplateCallback.call(),b.pagingTemplateCallback=null)}),b.postponed?b.postponed.call():f.id.indexOf("users.")==-1&&g([a.handle])})}})}],templateUrl:"/views/search/search-results.html"}}]),app.service("userManager",["$resource",function(a){var b=a("system/:path",{path:"@path"});this.menu={},this.userInfo={};var c=this;this.refreshing=!1,this.canUpdateAll=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].allOwners&&1==this.userInfo.role.permissions[a].allOwners},this.canCreate=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].create&&1==this.userInfo.role.permissions[a].create},this.canRead=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].read&&1==this.userInfo.role.permissions[a].read},this.canUpdate=function(a,b){if(this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].update&&1==this.userInfo.role.permissions[a].update)return!(!this.userInfo.role.permissions[a].allOwners||0==this.userInfo.role.permissions[a].allOwners)||this.userInfo._id==b},this.canApprove=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].approve&&1==this.userInfo.role.permissions[a].approve},this.canFlag=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].flag&&1==this.userInfo.role.permissions[a].flag},this.canHide=function(a){return this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a].hide&&1==this.userInfo.role.permissions[a].hide},this.canDelete=function(a,b){if(this.hasPermissions()&&this.userInfo.role.permissions[a]&&this.userInfo.role.permissions[a]["delete"]&&1==this.userInfo.role.permissions[a]["delete"])return!(!this.userInfo.role.permissions[a].allOwners||0==this.userInfo.role.permissions[a].allOwners)||this.userInfo._id==b},this.hasUser=function(){return!$.isEmptyObject(c.userInfo)},this.refresh=function(a){this.refreshing=!0,b.get({path:"userInfo"},function(b){c.menu=b.menu,c.userInfo=b.user,a&&a.call(null,c.hasUser())})},this.hasPermissions=function(){return this.userInfo&&this.userInfo.role&&this.userInfo.role.permissions},this.refresh()}]),app.service("resultHandler",["notifications",function(a){this.processing=!1,this.process=function(a,b,c){return a.redirect&&!c?(this.processing||(this.processing=!0,window.location=a.redirect+"?url="+window.location.hash.replace("#!/","")),!1):!a.errCode||(console.log(a),!1)}}]);var SearchExchange=function(){function a(){function a(a,b){for(var c=[],d=0;d<a.length;d++)if(a[d].dimension){var e={qDef:{qFieldDefs:[a[d].dimension]},qNullSuppression:a[d].suppressNull};if(b[a[d].dimension]){var f={};f[b[a[d].dimension].sortType]=b[a[d].dimension].order,e.qDef.qSortCriterias=[f]}c.push(e)}return c}function b(a){for(var b=[],c=0;c<a.length;c++)if(a[c].measure){var d={qDef:{qLabel:a[c].label,qDescription:"",qDef:a[c].measure}};a[c].sortType&&(d.qSortBy={},d.qSortBy[a[c].sortType]=a[c].order),b.push(d)}return b}var c=this;this.seqId=0,this.objects={},this.online=!1,this.clearing=!1,this.priority=[],this.queue=[],this.pendingSearch,this.pendingSuggest,this.state,this.view,this.catalog={},$.ajax({type:"GET",dataType:"text",contentType:"application/json",url:"/configs/sense.json",success:function(a){var b=JSON.parse(a);qsocks.Connect(b).then(function(a){a.openDoc(b.appname).then(function(a){function b(){c.ask(-1,"ProductVersion",[],function(a){}),setTimeout(function(){b()},3e4)}d=a;var e=d.connection.ws.onmessage;d.connection.ws.onmessage=function(a){var b=JSON.parse(a.data);b.suspend?c.publish("resume"):null!=e&&e(a)},c.seqId=d.connection.seqid,c.online=!0,b(),c.publish("online")},function(b){"1002"==b.code?a.getActiveDoc().then(function(a){d=a}):(console.log(b),$rootScope.$broadcast("senseoffline"))})})}}),this.subscribe=function(a,b,d){c.catalog[a]||(c.catalog[a]={}),c.catalog[a][b]&&delete c.catalog[a][b],c.catalog[a][b]={fn:d}},this.unsubscribe=function(a,b){delete c.catalog[a][b]},this.publish=function(a,b,d){if(c.catalog[a])if(c.view&&"online"!=a)for(var e in c.catalog[a])e.split(".")[0].indexOf(c.view)!=-1&&c.catalog[a][e].fn.call(null,b,d);else{var f=0;for(var e in c.catalog[a])c.catalog[a][e].fn.call(null,b,d),
f++}},this.subscribe("online","clear",function(){c.clear(!0)}),this.setStateAttr=function(a,b){c.state||(c.state={}),c.state[a]=b},this.matched;var d;this.init=function(a){a&&a.length>0?a.forEach(function(b,d){c.makeSelection(b,function(b){d==a.length-1&&c.lockSelections(function(a){c.executePriority()})},!0)}):c.executePriority()},this.executeQueue=function(){if(c.queue.length>0)for(var a=0;a<c.queue.length;a++)c.queue[a].call(),a==c.queue.length-1&&(c.queue=[],c.online?c.publish("update"):c.subscribe("online","queue",function(){c.publish("update")}));else c.online?c.publish("update"):c.subscribe("online","queue",function(){c.publish("update")})},this.executePriority=function(){c.priority&&c.priority.length>0?c.priority.forEach(function(a,b){a.call(null),(b=c.priority.length-1)&&(c.priority=[],c.executeQueue())}):c.executeQueue()},this.clear=function(a){this.clearing=!0;c.state=null,d&&(a&&1==a?c.ask(d.handle,"UnlockAll",[],function(a){c.ask(d.handle,"ClearAll",[],function(a){this.clearing=!1,c.publish("reset")})}):c.ask(d.handle,"ClearAll",[],function(a){this.clearing=!1,c.publish("cleared")}))},this.render=function(){c.publish("update")},this.fresh=function(){this.search("")},this.setPage=function(a){this.state||(this.state={}),this.state.page=a-1,this.publish("update")},this.search=function(a,b){c.setStateAttr("searchText",a),c.setStateAttr("searchFields",b),c.publish("searching"),c.terms=a.split(" "),c.seqId++,c.pendingSearch=c.seqId,d.connection.ask(d.handle,"SearchAssociations",[{qContext:"LockedFieldsOnly",qSearchFields:b},c.terms,{qOffset:0,qCount:5,qMaxNbrFieldMatches:5}],c.seqId).then(function(e){e.id==c.pendingSearch&&(""==a||e.result.qResults.qTotalSearchResults>0?c.ask(d.handle,"SelectAssociations",[{qContext:"LockedFieldsOnly",qSearchFields:b},c.terms,0],function(a){c.publish("update",a.change)}):c.publish("noresults",e.change))})},this.suggest=function(a,b){c.seqId++,c.pendingSuggest=c.seqId,d.connection.ask(d.handle,"SearchSuggest",[{qContext:"LockedFieldsOnly",qSearchFields:b},a.split(" ")],c.seqId).then(function(a){a.id==c.pendingSuggest&&c.publish("suggestResults",null,a.result.qResult)})},this.addFilter=function(a,b,e){var f;f=c.objects[a.id]?function(){b.call(null,{handle:c.objects[a.id]})}:function(){var e={qInfo:{qType:"ListObject"},qListObjectDef:{qStateName:"$",qDef:{qFieldDefs:[a.field]},qAutoSortByState:{qDisplayNumberOfRows:8}}};c.seqId++,d.connection.ask(d.handle,"CreateSessionObject",[e],c.seqId).then(function(d){c.objects[a.id]=d.result.qReturn.qHandle,b.call(null,{handle:d.result.qReturn.qHandle})})},c.online?f.call():c.subscribe("online",a.field,f)},this.makeSelection=function(a,b,e){(f=c.objects[a.field])?fn=function(){c.ask(f,"SelectValues",[a.values],function(a){b.call(null,a)})}:fn=function(){c.ask(d.handle,"GetField",[a.field],function(d){c.objects[a.field]=d.result.qReturn.qHandle,c.ask(d.result.qReturn.qHandle,"SelectValues",[a.values],function(a){b.call(null,a)})})},c.online?fn.call():c.subscribe("online",a.field,fn)},c.lockSelections=function(a){fn=function(){c.ask(d.handle,"LockAll",[],function(b){a.call(null)})},c.online?fn.call():c.subscribe("online","lock",fn)},this.addResults=function(e,f,g){c.objects[e.id]?fn=function(){f.call(null,{handle:c.objects[e.id]})}:fn=function(){var g={qInfo:{qType:"table"},qHyperCubeDef:{qDimensions:a(e.fields,e.sortOptions),qMeasures:b(e.fields),qSuppressZero:!1,qSuppressMissing:!1,qInterColumnSortOrder:e.defaultSort}};c.seqId++,d.connection.ask(d.handle,"CreateSessionObject",[g],c.seqId).then(function(a){c.objects[e.id]=a.result.qReturn.qHandle,f.call(null,{handle:a.result.qReturn.qHandle})})},c.online?fn.call():c.subscribe("online",e.id,fn)},this.ask=function(a,b,e,f){c.seqId++,d.connection.ask(a,b,e,c.seqId).then(function(a){f.call(null,a)})}}return a}(),searchExchange=new SearchExchange;app.service("picklistService",["$resource","resultHandler",function(a,b){var c=a("api/picklist/:picklistId",{picklistId:"@picklistId"}),d=a("api/picklistitem/:picklistitemId",{picklistitemId:"@picklistitemId"});this.getPicklistItems=function(a,e){c.get({name:a},function(a){b.process(a)&&a.data&&a.data[0]&&d.get({picklistId:a.data[0]._id},function(a){b.process(a)&&e.call(null,a.data)})})}}]),app.service("lastError",["$resource",function(a){var b=a("system/lasterror");this.checkForErrors=function(a){b.get({},function(b){a.call(null,b)})}}]),app.service("publisher",["$rootScope",function(a){var b=this;this.catalog={},this.subscribe=function(a,c,d){b.catalog[a]||(b.catalog[a]={}),b.catalog[a][c]||(b.catalog[a][c]={fn:d})},this.publish=function(a,c){if(b.catalog[a])for(var d in b.catalog[a])b.catalog[a][d].fn.call(null,c)}}]);var Templater=function(){function Templater(a,b){var c=document.createElement("div");c.innerHTML=a,a=c.innerHTML,a=a.replace(/(?:\r\n|\r|\n|\t|\n\t| \n\t)/g,""),a=a.replace(/\s{2,}/g," "),this.pieces=null,this.evalFn=null,this.templateHTML=a,a.indexOf("qs-repeat=")!==-1||a.indexOf("qs-show=")!==-1||a.indexOf("qs-if=")!==-1?this.evalFn=repeater(a):this.pieces=parse(a)}function parse(a){for(var b=/({{([^#^!^\/].*?)}})/g,c=[];s=b.exec(a);)c.push({what:s[0],item:s[0].replace("{{","").replace("}}","")});return c}function repeater(a){var b=document.createElement("div");b.innerHTML=a;var c=[],d=b.querySelectorAll("[qs-if]");if(d.length>0)for(var e=0;e<d.length;e++){var f=getHTMLString(d[e]),g=d[e].attributes?d[e].attributes["qs-if"].value:null;c.push({type:"qs-if",htmlItem:f,expression:g})}var h=b.querySelectorAll("[qs-repeat]");if(h.length>0)for(var e=0;e<h.length;e++){var f=getHTMLString(h[e]),g=h[e].attributes["qs-repeat"].value.split(" "),i=g[g.length-1],j=g[0]+' in data["'+i+'"]';c.push({type:"qs-repeat",htmlItem:f,dimension:i,repeater:g[0],loop:j,repeatPieces:parse(f)})}var k=b.querySelectorAll("[qs-show]");if(k.length>0)for(var e=0;e<k.length;e++){var f=getHTMLString(k[e]),g=k[e].attributes?k[e].attributes["qs-show"].value:null;c.push({type:"qs-show",htmlItem:f,expression:g})}var l=b.querySelectorAll("[qs-hide]");if(l.length>0)for(var e=0;e<l.length;e++){var f=getHTMLString(l[e]),g=l[e].attributes?l[e].attributes["qs-hide"].value:null;c.push({type:"qs-hide",htmlItem:f,expression:g})}var m=b.querySelectorAll("[qs-ref]");if(m.length>0)for(var e=0;e<m.length;e++){var f=getHTMLString(m[e]),g=m[e].attributes?m[e].attributes["qs-ref"].value:null;c.push({type:"qs-ref",htmlItem:f,expression:g})}return b.innerHTML=null,c}function getRepeatBlock(params,evalIterator,data,iteration){for(var that=this,htmlString=params.htmlItem,i=0;i<params.repeatPieces.length;i++)try{var what=params.repeatPieces[i].what,fields=params.repeatPieces[i].item.split("."),item=what;if(fields[0]==params.repeater){fieldFormatter=fields[fields.length-1].split(":");var df=fieldFormatter[1]||null;if(item=evalIterator,fields.length>1)for(var item=data,ii=1;ii<fields.length;ii++)prop=fields[ii],prop.indexOf(":")&&(prop=prop.split(":")[0]),item&&(item=item[prop]);if(item)if(df)try{if("NoHighlight"==df)htmlString=htmlString.replace(what,item);else{var date=new Date(parseInt(item));if("Date"==df)var day=date.getDate(),monthIndex=date.getMonth(),year=date.getFullYear(),output=day+" "+monthNames[monthIndex]+" "+year;if("Time"==df)var output=date.getHours()+":"+(date.getMinutes()<10?"0":"")+date.getMinutes();htmlString=htmlString.replace(what,output)}}catch(err){}else htmlString=htmlString.replace(what,highlightText(item,this.terms))}else"$"==fields[0]&&(item=parseInt(evalIterator)+1,item&&(htmlString=htmlString.replace(what,item)))}catch(err){console.log("error",htmlString)}for(var myEval=function(expr){var rootExpr;expr.indexOf("(")==-1&&(rootExpr=expr.split("."),rootExpr.length>1&&rootExpr.splice(0,1),rootExpr=rootExpr.join("."));var s=!0;try{expr.indexOf("(")!=-1?eval("s="+expr):eval("var o=data; if (that.data."+rootExpr+" || data."+rootExpr+" || that.data."+expr+" || data."+expr+" || "+expr+") { s=true; } else { s=false; }")}catch(err){s=!1}finally{}return s},fn=repeater(htmlString),fnAlt=repeater(htmlString),k=0;k<fn.length;k++)if("qs-if"===fn[k].type)myEval(fn[k].expression)===!1&&(fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),htmlString=htmlString.replace(fn[k].htmlItem,"")),fn=repeater(htmlString);else if("qs-show"===fn[k].type){var show=myEval(fn[k].expression);if(show===!0){if(fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),htmlString.indexOf(fn[k].htmlItem)!=-1){var str=fn[k].htmlItem.replace("qs-show",'style="display:inherit;" qs-done');htmlString=htmlString.replace(fn[k].htmlItem,str)}fn=repeater(htmlString)}}else if("qs-hide"===fn[k].type){var show=myEval(fn[k].expression);if(show===!0){if(fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),htmlString.indexOf(fn[k].htmlItem)!=-1){var str=fn[k].htmlItem.replace("qs-hide",'style="display:none;" qs-done');htmlString=htmlString.replace(fn[k].htmlItem,str)}fn=repeater(htmlString)}}else if("qs-ref"===fn[k].type){var loc=window.location.hash.split("?")[0];if(loc+="?"+fn[k].expression,loc=loc.replace(/%22/g,""),fn[k].htmlItem=fn[k].htmlItem.replace(/&amp;/g,"&"),htmlString.indexOf(fn[k].htmlItem)!=-1){var str=fn[k].htmlItem.replace("qs-ref","href="+loc+" qs-done");htmlString=htmlString.replace(fn[k].htmlItem,str)}fn=repeater(htmlString)}if(fnAlt&&fnAlt.length>iteration)for(var j=iteration;j<fnAlt.length;j++)if("qs-repeat"===fnAlt[j].type){htmlString=repeat.call(this,htmlString,fnAlt[j].htmlItem,fnAlt[j],data[fnAlt[j].dimension],j);break}return htmlString}function repeat(a,b,c,d,e){e++;var f="",b=c.htmlItem;if(a.indexOf(b)!==-1){for(var g in d)f+=getRepeatBlock.call(this,c,g,d[g],e);return a.replace(b,f)}return""}function getHTMLString(a){if(!a||!a.tagName)return"";if(a.outerHTML)return a.outerHTML;var b=document.createElement("div");b.appendChild(a.cloneNode(!0));var c=b.innerHTML;return b.innerHTML=null,c}function highlightText(a,b){if(a=a.replace(/<\/?[^>]+(>|$)/g,""),b)for(var c=0;c<b.length;c++)a=a.replace(new RegExp(b[c],"i"),"<span class='highlight"+c+"'>"+b[c]+"</span>");return a}function withinRange(a,b,c,d){var e,f;return 1!=c&&(b<=2?(e=1,f=d):b>=c-2?(e=c-d,f=c):(e=b-2,f=b+2),a>=e&&a<=f)}Templater.prototype=Object.create(Object.prototype,{getHTML:{value:function(data){var that=this;this.compiledHTML=this.templateHTML,this.data=data,this.terms=data.terms;var myEval=function(expr){var rootExpr=expr.split(".");rootExpr.length>1&&rootExpr.splice(0,1),rootExpr=rootExpr.join(".");var s=!0;try{eval("var o=data; if (that.data."+rootExpr+" || data."+rootExpr+" || that.data."+expr+" || data."+expr+" || "+expr+") { s=true; } else { s=false; }")}catch(err){s=!1}finally{}return s},fn=this.evalFn;if(fn&&fn.length>0){for(var i=0;i<fn.length;i++)if("qs-repeat"===fn[i].type){this.compiledHTML=repeat.call(this,this.compiledHTML,fn[i].htmlItem,fn[i],data[fn[i].dimension],i);break}for(var i=0;i<fn.length;i++)if("qs-show"===fn[i].type){var show=myEval(fn[i].expression)===!0?"inherit":"none";if(fn[i].htmlItem=fn[i].htmlItem.replace(/&amp;/g,"&"),this.compiledHTML.indexOf(fn[i].htmlItem)!=-1){var str=fn[i].htmlItem.replace("qs-show",'style="display:'+show+'" qs-done');this.compiledHTML=this.compiledHTML.replace(fn[i].htmlItem,str)}}else if("qs-hide"===fn[i].type){var show=myEval(fn[i].expression)===!0?"none":"inherit";if(fn[i].htmlItem=fn[i].htmlItem.replace(/&amp;/g,"&"),this.compiledHTML.indexOf(fn[i].htmlItem)!=-1){var str=fn[i].htmlItem.replace("qs-hide",'style="display:'+show+'" qs-done');this.compiledHTML=this.compiledHTML.replace(fn[i].htmlItem,str)}}}this.pieces=parse(this.compiledHTML);for(var i=0;i<this.pieces.length;i++)try{var props=this.pieces[i].item.split("."),result=data;for(var p in props)result=result[props[p]];result&&(this.compiledHTML=this.compiledHTML.replace(this.pieces[i].what,result))}catch(err){console.log("error",data.toString())}return this.compiledHTML}}});var monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return Templater}();app.controller("adminController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","confirm",function(a,b,c,d,e,f,g){var h=b("api/userprofile/:userId",{userId:"@userId"}),i=b("api/project/:projectId",{projectId:"@projectId"}),j=b("api/userrole/:roleId",{roleId:"@roleId"}),k=b("api/feature/:featureId",{featureId:"@featureId"}),l=b("api/picklist/:picklistId",{picklistId:"@picklistId"}),m=b("api/picklistitem/:picklistitemId",{picklistitemId:"@picklistitemId"}),n=b("api/images/:imageName",{imageName:"@imageName"}),o=null;a.userManager=e,a.$on("$stateChangeSuccess",function(a,b,c,d,f){e.refresh(function(a){a?"admin"!=e.userInfo.role.name&&(window.location="/"):window.location="/"})}),a.doingStuff=!1,a.collections=["user","userprofile","userrole","feature","project","comment","resource","picklist","picklistitem","flag","rating","subscription"];a.getImages=function(){n.get({},function(b){f.process(b)&&(a.images=b.data)})},a.getImages(),h.get({},function(b){f.process(b)&&(a.users=b.data,a.userInfo=b,delete a.userInfo.data)}),j.get({},function(b){f.process(b)&&(a.roles=b.data,a.roleInfo=b,delete a.roleInfo.data,a.setRole(0))}),k.get({},function(b){f.process(b)&&(a.features=b.data,a.featureInfo=b,delete a.featureInfo.data,a.setActiveFeature(0))}),l.get({},function(b){f.process(b)&&(a.picklists=b.data,a.picklistInfo=b,delete a.picklistInfo.data,a.setActivePickList(0))}),a.activeRole=0,a.activePicklist=0,a.activeTab=0,a.activeFeature=0,a.setTab=function(b){a.activeTab=b,searchExchange.clear(!0),4===b&&null==o&&(o=new Dropzone("#adminImages",{previewTemplate:document.querySelector("#preview-template").innerHTML,addRemoveLinks:!0,parallelUploads:2,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:3,filesizeBase:1e3}),o.on("complete",function(b){o.removeAllFiles(!0),a.getImages()}))},a.setRole=function(b){a.activeRole=b,a.copyRoleName=a.roles[a.activeRole].name},a.setActivePickList=function(b){a.activePicklist=b,a.getPicklistItems(a.picklists[b]._id),a.copyListName=a.picklists[a.activePicklist].name},a.setActiveFeature=function(b){a.activeFeature=b,k.get({_id:a.features[a.activeFeature]._id},function(b){f.process(b)&&b.data&&b.data.length>0&&(a.currentFeature=b.data[0])})},a.saveRole=function(){j.save({roleId:a.roles[a.activeRole]._id},a.roles[a.activeRole],function(b){f.process(b,"Save")&&a.userManager.refresh()})},a.savePicklist=function(){Picklists.save({picklistId:a.picklists[a.activePicklist]._id},a.picklists[a.activePicklist],function(a){f.process(a,"Save")})},a.newRole=function(b){var c=this;j.save({},{name:b},function(b){f.process(b,"Create")&&(a.roles.push(b),c.newrolename="",a.setRole(a.roles.length-1))})},a.newPicklist=function(b){var c=this;l.save({},{name:b},function(b){f.process(b)&&(a.picklists.push(b),c.newlistname="",a.setActivePickList(a.picklists.length-1))})},a.newPicklistItem=function(b){var c=this,d={name:b,picklistId:a.picklists[a.activePicklist]._id,seq:a.picklistItems.length};c.newlistitem="",a.savePicklistItem(d)},a.getPicklistItems=function(b){m.get({picklistId:b},function(b){f.process(b)&&(a.picklistItems=b.data)})},a.savePicklistItem=function(b){m.save({picklistitemId:b._id||""},b,function(b){f.process(b)&&(a.picklistItems?a.picklistItems.push(b):a.picklistItems=[b])})},a.copyRole=function(b){var c=a.roles[a.activeRole];b==c.name&&(b+=" - copy"),j.save({},{name:b,permissions:c.permissions},function(b){f.process(b)&&(a.roles.push(b),a.setRole(a.roles.length-1))})},a.$on("setFeature",function(b,c){a.setFeature(c[0])}),searchExchange.subscribe("setFeature","adminConsole",function(b,c){a.setFeature(b,c)}),a.changeFeatureImage=function(){g.prompt("Would you like to upload an image or enter a url to link to?",{options:["Upload","Link","Cancel"]},function(b){0==b.result||1==b.result&&g.prompt("Please enter a link to an image",{requireComment:!0,options:["Ok","Cancel"]},function(b){0==b.result&&(a.currentFeature.image=b.comment,a.saveFeature())})})},a.setFeature=function(b,c){"project"===b?a.getProject(c,function(b){a.currentFeature.entityId=b._id,a.currentFeature.title=b.title,a.currentFeature.comment=b.short_description,a.currentFeature.image=null==b.image?b.thumbnail:b.image,a.currentFeature.userid=b.userid._id,k.save({featureId:a.currentFeature._id},a.currentFeature,function(b){f.process(b)&&a.setActiveFeature(a.activeFeature)})}):(a.currentFeature.entityId=null,a.currentFeature.title=c[0],a.currentFeature.comment=c[1],a.currentFeature.image=c[2],a.currentFeature.link=c[3],a.currentFeature.userid=null,k.save({featureId:a.currentFeature._id},a.currentFeature,function(b){f.process(b)&&a.setActiveFeature(a.activeFeature)}))},a.getProject=function(a,b){i.get({projectId:a},function(a){f.process(a)&&a.data&&a.data[0]?b.call(null,a.data[0]):b.call(null,null)})},a.saveFeature=function(){k.save({featureId:a.features[a.activeFeature]._id},a.currentFeature,a.features[a.activeFeature],function(b){f.process(b)&&a.setActiveFeature(a.activeFeature)})},a.highlightRow=function(b){return a.features[a.activeFeature].entityId==b},a.copyUrl=function(a){window.prompt("Copy the URL below",a)},a.removeImage=function(b){n["delete"]({imageName:b},function(b){console.log(b),a.getImages()})},a.deletePicklistItem=function(b){a.doingStuff=!0,m["delete"]({picklistitemId:b},function(b){a.doingStuff=!1,f.process(b)&&a.setActivePickList(a.activePicklist)})},a.movePicklistItem=function(b,c){var d=a.picklistItems[b],e=a.picklistItems[b+c];originalA=d.seq||b,originalB=d.seq||b+c,d.seq||(d.seq=originalA),e.seq||(e.seq=originalB),d.seq+=c,e.seq-=c,m.save({picklistitemId:d._id},d,function(b){f.process(b)&&m.save({picklistitemId:e._id},e,function(b){f.process(b)&&(a.picklistItems.splice(originalA,1),a.picklistItems.splice(originalA+=c,0,d))})})},a.$on("$stateChangeSuccess",function(b,c,d,e,f){"loginsignup"!=c.name&&(searchExchange.view=c.name.split(".")[0]),a.setTab(0)})}]),app.controller("moderatorController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","confirm",function(a,b,c,d,e,f,g){var h=b("api/flag/:flagId",{flagId:"@flagId"}),i=["project","comment","user"];a.isModerator=!1,a.activeTab=0,a.showComments=!1,a.commentsType,a.commentsTitle,a.comments=[],a.commentsTemplate,a.commentsTemplate||$.get("/views/moderator/moderator-comments.html").success(function(b){a.commentsTemplate=new Templater(b)});var j;a.setTab=function(b){a.activeTab=b,searchExchange.clear()},searchExchange.subscribe("clearFlags","moderatorController",function(a,b){h.save({entityId:b,flagType:a},{flagged:!1},function(a){f.process(a)})}),searchExchange.subscribe("viewComments","moderatorController",function(b,c){a.commentsTitle=b[1];var d=b[0];a.commentType="flag"==b[0]?"Flag":"Spam",h.get({entityId:c,flagType:d,flagged:!0},function(b){f.process(b)&&(document.getElementById("moderator_comments").innerHTML=a.commentsTemplate.getHTML({commentType:a.commentType,commentsTitle:a.commentsTitle,comments:b.data}),document.getElementById("moderator_comments_container").style.display="block")})}),searchExchange.subscribe("closeComments","moderatorController",function(){document.getElementById("moderator_comments").innerHTML="",document.getElementById("moderator_comments_container").style.display="none"}),a.$on("$stateChangeSuccess",function(b,c,d,f,g){if(f.name.split(".")[0]==c.name.split(".")[0]&&1==c.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=c.name&&(searchExchange.view=c.name.split(".")[0]),f.name.split(".")[0]==c.name.split(".")[0]&&"loginsignup"!=f.name||searchExchange.clear(!0),j=[],e.hasUser()){for(var h=[],k=0;k<i.length;k++)e.canApprove(i[k])&&(a.isModerator=!0,h.push({qText:i[k]}));j=[{field:"DocType",values:h}],a.isModerator||(window.location="/"),searchExchange.subscribe("reset","moderator",function(){searchExchange.init(j),searchExchange.unsubscribe("reset","moderator")}),f.name.split(".")[0]==c.name.split(".")[0]&&"loginsignup"!=f.name||searchExchange.clear(!0)}else e.refresh(function(b){if(b){for(var d=[],g=0;g<i.length;g++)e.canApprove(i[g])&&(a.isModerator=!0,d.push({qText:i[g]}));j=[{field:"DocType",values:d}]}else window.location="#!login?url=moderator";console.log(a.isModerator),a.isModerator||(window.location="/"),searchExchange.subscribe("reset","moderator",function(){searchExchange.init(j),searchExchange.unsubscribe("reset","moderator")}),f.name.split(".")[0]==c.name.split(".")[0]&&"loginsignup"!=f.name||searchExchange.clear(!0)})}),a.setTab(0)}]),app.controller("authController",["$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications","lastError",function(a,b,c,d,e,f,g,h,i){var j=b("auth/login"),k=b("auth/signup"),l=b("auth/check"),m=b("auth/reset"),n=b("recaptcha");a.authLoading=!1,a.resetting=!1,a.response=null,a.widgetId=null,a.model={key:"invalid key"},n.get({},function(b){a.model=b}),a.setResponse=function(b){a.response=b},a.setWidgetId=function(b){a.widgetId=b},a.cbExpiration=function(){i.reload(a.widgetId),a.response=null},a.$on("$stateChangeSuccess",function(a,b,c,d,e){h.checkForErrors(function(a){a.errCode&&g.notify(a.errText,[],{sentiment:"warning"})})}),d.url&&(a.returnUrl=d.url.replace(/%2F/gi,"")),a.login=function(){a.authLoading=!0,j.save({username:a.loginusername,password:a.loginpassword},function(b){if(f.process(b)){e.refresh(),searchExchange.clear(!0);var c=/^https?:\/\//i;c.test(a.returnUrl)?window.location=a.returnUrl:window.location="#!"+a.returnUrl||"/"}else a.authLoading=!1,g.notify(b.errText,null,{sentiment:"negative"})})},a.signup=function(){return null==a.unsubscribed?void g.notify("Please answer the scary marketing question",null,{sentiment:"negative"}):void l.get({username:a.username,email:a.email},function(b){b.found?g.notify(b.message,null,{sentiment:"negative"}):n.save({response:a.response},function(b){b.success?k.save({username:a.username,password:a.password,email:a.email,company:a.company,country:a.country,fullname:a.fullname,unsubscribed:a.unsubscribed},function(b){if(f.process(b)){e.refresh();var c=/^https?:\/\//i;c.test(a.returnUrl)?window.location=a.returnUrl:window.location="#!"+a.returnUrl||"/"}else a.authLoading=!1,g.notify(b.errText,null,{sentiment:"negative"})}):g.notify("Please make sure you have clicked on the captcha",null,{sentiment:"negative"})},function(a){g.notify("There was an issue validating the captcha",null,{sentiment:"negative"})})})},a.reset=function(){a.resetting=!0,m.save({email:a.email},function(b){f.process(b)?(a.resetting=!1,e.refresh(),a.email="",g.notify("An email has been sent to the specified address.",null,{sentiment:"positive"})):(a.resetting=!1,g.notify(b.errText,null,{sentiment:"negative"}))})}}]),app.controller("homeController",["$rootScope","$scope","$resource","$state","$stateParams","userManager","resultHandler",function(a,b,c,d,e,f,g){var h=c("api/feature/:featureId",{featureId:"@featureId"}),i=c("api/project/:projectId",{projectId:"@projectId"}),j=c("api/publication/:publicationId",{publicationId:"@publicationId"});b.featuredProject={},b.featuredArticle={},a.headTitle="Welcome to Qlik Branch",a.metaKeys="Branch, Qlik Branch, Qlik Sense, Qlik, Data Analytics, Data Visualization, QlikView, Developers, APIs, Github, Open Source, Developer Relations, Innovation",a.metaDesc="Qlik Branch is a game-changing platform for web developers using Qlik's APIs to accelerate innovation in bringing the best ideas to market. Rooted in open source philosophy, all projects are freely distributed and modified, allowing faster collaboration and innovation.",a.metaImage="http://branch.qlik.com/resources/branch_logo.png",h.get({},function(a){if(g.process(a)){b.features=a.data,b.featureInfo=a,delete b.featureInfo.data;for(var c in b.features){b.features[c].entityId;switch(b.features[c].name){case"project":b.featuredProject=b.features[c];break;case"article":b.featuredArticle=b.features[c]}}}}),i.get({sort:"createdate_num",sortOrder:"-1",limit:"3"},function(a){g.process(a)&&(b.latestProjects=a.data)}),j.get({sort:"published_num",sortOrder:"-1",limit:"3"},function(a){g.process(a)&&(b.latestArticles=a.data)})}]),app.controller("projectController",["$sce","$rootScope","$scope","$resource","$state","$stateParams","$anchorScroll","userManager","resultHandler","confirm","notifications","picklistService","$window",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;e<d;e++)b+=String.fromCharCode(c[e]);return b}var o,p=d("api/project/:projectId",{projectId:"@projectId"}),q=d("api/view/count"),r=(d("api/picklist/:picklistId",{picklistId:"@picklistId"}),d("api/picklistitem/:picklistitemId",{picklistitemId:"@picklistitemId"}),d("system/git/:path",{path:"@path"})),s=d("api/rating");d("api/rating/rating/my");b.headTitle="Open Source Projects on Qlik Branch",b.metaKeys="Branch, Qlik Branch, Qlik Sense, Qlik, Open Source, Github, Projects, Extensions, Mash-ups, API, QAP, Qlik Analytics Platform",b.metaDesc="Qlik Branch integrates with Github to host open source projects leveraging Qlik's extensibility and APIs.  Find code to use as a foundation for your next project, share your work, or get inspired.",b.metaImage="http://branch.qlik.com/resources/branch_logo.png",c.dirtyThumbnail=!1,c.gitCreds={},c.userManager=h,c.gitAuthenticated=h.userInfo.linked_to_github,c.Confirm=j,c.isNew="new"==f.projectId,c.projects=[],c.gitProjects=[],c.url="projects",c.searching=!0,c.projectLoading=!c.isNew,c.gitLoading=!1,c.rating={},c.getRate={},c.query={limit:c.pageSize},f.sort&&c.sortOptions[f.sort]&&(c.sort=c.sortOptions[f.sort]),f.projectId&&(c.query.projectId=f.projectId,c.projectId=f.projectId),c.ratingClick=function(){if(c.rate&&!c.isReadonly){c.isReadonly=!0,c.query.votenum=c.projects[0].votenum+1,c.query.votetotal=c.projects[0].votetotal+c.rate,c.updateProjectData(c.query),c.rating.id=c.projects[0]._id,c.rating.userid=f.userId,c.rating.rate=c.rate,c.rating.date=new Date;var a={entityId:c.rating.id,userid:c.rating.userid,createdate:c.rating.date,rating:c.rating.rate};c.saveRating(a)}},c.getProductVersions=function(a){l.getPicklistItems(a.name+" Version",function(a){c.productVersions=a})},c.getProjectData=function(a,d){c.projectLoading=!0,p.get(a,function(a){i.process(a)&&(c.projectLoading=!1,a.data&&a.data.length>0?(d&&1==d?c.projects=c.projects.concat(a.data):c.projects=a.data,q.get({entityId:a.data[0]._id},function(a){console.log(a),i.process(a)&&(c.projects[0].views=a.count)}),b.headTitle=c.projects[0].title+": Qlik Branch Projects",b.metaKeys=c.projects[0].tags+", Open Source, Github, Projects, QAP, Qlik Analytics Platform",b.metaDesc=c.projects[0].short_description,null!=c.projects[0].image&&""!=c.projects[0].image&&(b.metaImage=c.projects[0].image,"//"===b.metaImage.substr(0,2)&&(b.metaImage="http:"+b.metaImage))):window.location="#!noitem",f.status&&("created"==f.status?k.notify("Your project has been successfully submitted for approval.",null,{sentiment:"positive"}):"updated"==f.status&&k.notify("Your project has been successfully updated. It may take up to 5 minutes for the listing page to reflect these changes.",null,{sentiment:"positive"})),c.projects.forEach(function(a,b){if(a.votenum>0){var d=Math.round(a.votetotal/a.votenum);c.projects[b].stars=new Array(d)}}),c.projectInfo=a,delete c.projectInfo.data,c.getProductVersions(c.projects[0].product))})},c.getRating=function(a,b){return b&&b>0?Math.round(parseInt(a)/parseInt(b)):0},c.updateProjectData=function(a){p.save(a,function(a){i.process(a)})},c.saveRating=function(a){s.save(a,function(a){i.process(a)})},c.getBuffer=function(a){return n(a)},c.getPageText=function(){if(c.projects[0]&&c.projects[0].content){var b=marked(c.projects[0].content);return a.trustAsHtml(b)}},c.applySort=function(){window.location="#!project?sort="+c.sort.id+"&product="+c.productId+"&category="+c.categoryId},c.getAllGitProjects=function(a,b,d){c.gitCreds={user:a,password:b,code:d},c.getGitProjects(c.gitCreds)},c.getGitProjects=function(a){c.gitLoading=!0,c.gitError=null,r.save({path:"projects"},a,function(a){if(console.log(a),i.process(a))c.gitAuthenticated=!0,console.log(a),"2fa"==a.status?(console.log("need 2fa"),c.is2fa=!0):c.gitProjects=a.repos,c.gitLoading=!1;else{c.gitAuthenticated=c.userManager.userInfo.linked_to_github;var b;try{var b=JSON.parse(a.errText);c.gitError=b.message}catch(d){c.gitError=a.errText}c.gitLoading=!1}})},c.searchGithub=function(a){var b=angular.copy(c.gitCreds);b.search=a,c.getGitProjects(b)},c.selectGitProject=function(a){c.projects[0].project_site=a.html_url,c.projects[0].git_clone_url=a.clone_url,c.projects[0].git_repo=a.name,c.projects[0].git_user=a.owner.login,c.projects[0].download_link="https://github.com/"+a.owner.login+"/"+a.name+"/zipball/master"},c.GithubGATracking=function(){var a=c.projects[0].project_site;console.log(a),m.ga("send","event",{eventCategory:"GithubLink",eventAction:"click",eventLabel:a,transport:"beacon"})},c.checkIfVersionChecked=function(a){return!(!c.projects[0]||!c.projects[0].productversions)&&c.projects[0].productversions.indexOf(a)!=-1},c.previewThumbnail=function(){c.dirtyThumbnail=!0;var a=$("#thumbnail")[0].files[0],b=a.name,d=a.type,e=new FileReader;e.onloadend=function(a){var f=document.createElement("canvas"),g=f.getContext("2d"),h=document.createElement("canvas"),i=h.getContext("2d"),j=new Image;j.onload=function(){var a=j.width,e=j.height;f.width=a,f.height=e,h.width=a*(77/e),h.height=77,g.drawImage(j,0,0,f.width,f.height),c.image={type:d,name:b,data:f.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},i.drawImage(j,0,0,h.width,h.height),c.thumbnail={type:d,name:b,data:h.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},c.$apply(function(){c.projects[0].thumbnail=h.toDataURL()})},j.src=e.result},e.readAsDataURL(a)},c.validateNewProjectData=function(){var a=[];c.projects[0].title&&""!=c.projects[0].title||a.push("Please specify a Name"),c.projects[0].short_description&&""!=c.projects[0].short_description||a.push("Please add a Short Description"),c.projects[0].category||a.push("Please select a Project Type"),c.projects[0].status||a.push("Please select a Project Status"),c.projects[0].product||a.push("Please select a Product"),c.projects[0].product&&0==$(".product-version:checkbox:checked").length&&a.push("Please specify at least one Product Version"),c.isNew&&!c.projects[0].git_repo&&a.push("Please select a Git project to use"),"false"!=c.usegit||$("#newProjectContent").code()||a.push("Please add some content to the project (e.g. documentation, installation instructions)."),a.length>0?(k.notify("The project could not be saved. Please review the following...",a,{sentiment:"warning"}),window.scrollTo(100,0)):c.saveNewProject()},c.saveNewProject=function(){var a=[];c.projectLoading=!0,$(".product-version:checkbox:checked").each(function(b,d){a.push($(this).attr("data-versionid")),b==$(".product-version:checkbox:checked").length-1&&(c.projects[0].productversions=a)});var b={standard:c.projects[0]};c.dirtyThumbnail&&(b.special={image:c.image,thumbnail:c.thumbnail});var d={};c.projects[0]._id&&(d.projectId=c.projects[0]._id),p.save(d,b,function(a){if(c.projectLoading=!1,i.process(a)){var b=c.isNew?"created":"updated";window.location="#!project/"+a._id+"?status="+b}else k.notify(a.errText,null,{sentiment:"negative"})})},c.search=function(){searchExchange.clear(),c.searching=!0},c.browse=function(){searchExchange.clear(),c.searching=!1},c.clear=function(){searchExchange.clear()},c.removedefaultSelection=function(a){for(var b=0;b<o.length;b++)o[b].field==a&&o.splice(b,1)},c.filterProduct=function(a){c.removedefaultSelection("product"),"QlikView"==a?($(".qlikview-filter").hasClass("active")?$(".qlikview-filter").removeClass("active"):($(".qlikview-filter").addClass("active"),c.addDefaultSelection("product",[{qText:a}])),$(".qlik-sense-filter").removeClass("active")):($(".qlik-sense-filter").hasClass("active")?$(".qlik-sense-filter").removeClass("active"):($(".qlik-sense-filter").addClass("active"),c.addDefaultSelection("product",[{qText:a}])),$(".qlikview-filter").removeClass("active")),searchExchange.subscribe("reset","projects",function(){
searchExchange.init(o),searchExchange.unsubscribe("reset","projects")}),searchExchange.clear(!0)},c.addDefaultSelection=function(a,b){o.push({field:a,values:b})},c.$on("$stateChangeSuccess",function(a,b,d,g,i){if(g.name.split(".")[0]==b.name.split(".")[0]&&1==b.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=b.name&&(searchExchange.view=b.name.split(".")[0]),g.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=g.name||searchExchange.clear(!0),o=[],"projects.detail"==e.current.name)c.getProjectData(c.query),h.refresh(function(a){c.currentuserid=h.userInfo._id});else if("projects.addedit"==e.current.name){l.getPicklistItems("Product",function(a){c.projectProducts=a}),l.getPicklistItems("Category",function(a){c.projectCategories=a}),l.getPicklistItems("Project Status",function(a){c.projectStatuses=a}),"new"==f.projectId&&(c.projects=[{}]);var j=h.hasUser();j?"new"!=f.projectId?c.getProjectData(c.query):1==h.userInfo.linked_to_github&&c.getAllGitProjects():h.refresh(function(a){a?"new"!=f.projectId?c.getProjectData(c.query):1==h.userInfo.linked_to_github&&c.getAllGitProjects():window.location="#!login?url=project/"+f.projectId+"/edit"})}else h.hasUser()?(h.canApprove("project")||(o=[{field:"approved",values:[{qText:"True"}]}]),searchExchange.subscribe("reset","projects",function(){searchExchange.init(o),searchExchange.unsubscribe("reset","projects")}),g.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=g.name||searchExchange.clear(!0)):h.refresh(function(a){a?h.canApprove("project")||(o=[{field:"approved",values:[{qText:"True"}]}]):o=[{field:"approved",values:[{qText:"True"}]}],searchExchange.subscribe("reset","projects",function(){searchExchange.init(o),searchExchange.unsubscribe("reset","projects")}),g.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=g.name||searchExchange.clear(!0)})})}]),app.controller("publicationController",["$sce","$rootScope","$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications","picklistService",function(a,b,c,d,e,f,g,h,i,j){var k=d("api/publication/:publicationId",{publicationId:"@publicationId"});c.pageSize=20,c.query={};var l;b.headTitle="Blog: Qlik Branch",b.metaKeys="Branch, Qlik Branch, Blog, Articles, Updates, News, Qlik Sense, Qlik, Open Source",b.metaDesc="The Qlik Branch Blog is a place for developers to read helpful and interesting articles about using our APIs as well as news and communications about anything relevant to developers.",b.metaImage="http://branch.qlik.com/resources/branch_logo.png",f.publicationId&&(c.query.publicationId=f.publicationId),c.getPublicationData=function(a,b){k.get(a,function(a){c.publicationLoading=!1,h.process(a)&&(a.link?window.location=a.link:window.location="#!noitem")})},c.$on("$stateChangeSuccess",function(a,b,d,f,g){"publications.redirect"==e.current.name?c.getPublicationData(c.query):(f.name.split(".")[0]==b.name.split(".")[0]&&1==b.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=b.name&&(searchExchange.view=b.name.split(".")[0]),f.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=f.name||searchExchange.clear(!0),l=[],searchExchange.subscribe("reset","publications",function(){searchExchange.init(l),searchExchange.unsubscribe("reset","publications")}),f.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=f.name||searchExchange.clear(!0))})}]),app.controller("resourceController",["$sce","$rootScope","$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications","picklistService",function(a,b,c,d,e,f,g,h,i,j){function k(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;e<d;e++)b+=String.fromCharCode(c[e]);return b}function l(a){var b=a.replace(/<img[^>]*>/g,"[image]");return noHTML=b.replace(/<\/?[^>]+(>|$)/g,""),noHTML}var m=d("api/resource/:resourceId",{resourceId:"@resourceId"}),n=d("api/resource/image/:url",{url:"@url"});c.pageSize=20,c.query={},c.simplemde,c.resourceLoading="new"!=f.resourceId,c.isNew="new"==f.resourceId,c.resourceTypes,b.headTitle="Resource Center: Qlik Branch",b.metaKeys="Branch, Qlik Branch, Resource Center, Tutorials, Tips, Learning, Getting Started, Knowledge Base, Qlik, Open Source",b.metaDesc="The Qlik Branch Resource Center is a repository for knowledge created and shared by the Qlik web developer community.  It holds content such as tutorials, tips, tricks, snippets, videos, and anything else that could be helpful in developing with the Qlik platform.",b.metaImage="http://branch.qlik.com/resources/branch_logo.png",j.getPicklistItems("Resource Type",function(a){c.resourceTypes=a,c.newresourceType=a[0]}),f.resourceId&&(c.query.resourceId=f.resourceId,c.resourceId=f.resourceId),c.getResourceData=function(a,b){m.get(a,function(a){c.resourceLoading=!1,h.process(a)&&(a.data&&a.data.length>0?(f.status&&("created"==f.status?i.notify("Your resource has been successfully submitted for approval.",null,{sentiment:"positive"}):"updated"==f.status&&i.notify("Your resource has been successfully updated. It may take up to 5 minutes for the listing page to reflect these changes.",null,{sentiment:"positive"})),b&&1==b?c.resources=c.resources.concat(a.data):c.resources=a.data,"rc.addedit"==e.current.name&&c.simplemde.value(k(a.data[0].content.data)),c.resourceInfo=a,delete c.resourceInfo.data):window.location="#!noitem")})},c.validateNewResourceData=function(){var a=[];c.resources[0].title&&""!=c.resources[0].title||a.push("Please specify a title"),c.resources[0].resourceType||a.push("Please select a Type"),0!=c.simplemde.value().length&&12!=c.simplemde.value().length||a.push("Please add some content"),a.length>0?(i.notify("The resource post could not be saved. Please review the following...",a,{sentiment:"warning"}),window.scrollTo(100,0)):c.saveResource()},c.saveResource=function(){c.resourceLoading=!0,c.resources[0].content=c.simplemde.value(),c.resources[0].plaintext=l(c.resources[0].content);var a={standard:c.resources[0],special:{markdown:!0}},b={};c.resources[0]._id&&(b.resourceId=c.resources[0]._id),m.save(b,a,function(a){if(c.resourceLoading=!1,h.process(a)){var b=c.isNew?"created":"updated";window.location="#!resource/"+a._id+"?status="+b}else i.notify(a.errText,null,{sentiment:"negative"})})},c.getResourceContent=function(b){if(b&&b.data){var c=k(b.data),d=marked(c);return a.trustAsHtml(d)}return""},c.addImageToMarkdown=function(a){var b="![]("+a+")";c.simplemde.codemirror.replaceSelection(b)},c.$on("$stateChangeSuccess",function(a,b,d,h,i){if(h.name.split(".")[0]==b.name.split(".")[0]&&1==b.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=b.name&&(searchExchange.view=b.name.split(".")[0]),h.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=h.name||searchExchange.clear(!0),defaultSelection=[],"rc.detail"==e.current.name)c.getResourceData(c.query),g.refresh(function(a){c.currentuserid=g.userInfo._id});else if("rc.addedit"==e.current.name){c.simplemde=new SimpleMDE({element:$("#resourceContent")[0],placeholder:"Resource content uses markdown. If you would like to add an image to your markdown you can upload the image below, then click the image to add."});var k=new Dropzone("#resourceImages",{previewTemplate:document.querySelector("#preview-template").innerHTML,addRemoveLinks:!0,parallelUploads:2,thumbnailHeight:120,thumbnailWidth:120,maxFilesize:3,filesizeBase:1e3});k.on("success",function(a,b){a.url=b.url,a.previewElement.addEventListener("click",function(){c.addImageToMarkdown(b.url)})}),k.on("removedfile",function(a){n["delete"]({url:a.url},function(b){console.log("Removed",a.url)})}),j.getPicklistItems("Resource Type",function(a){c.resourceTypes=a}),"new"==f.resourceId&&(c.resources=[{}]);var l=g.hasUser();l?"new"!=f.resourceId&&c.getResourceData(c.query):g.refresh(function(a){a?"new"!=f.resourceId&&c.getResourceData(c.query):window.location="#!login?url=resource/"+f.resourceId+"/edit"})}else g.hasUser()?(g.canApprove("resource")||(defaultSelection=[{field:"approved",values:[{qText:"True"}]}]),searchExchange.subscribe("reset","resources",function(){searchExchange.init(defaultSelection),searchExchange.unsubscribe("reset","resources")}),h.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=h.name||searchExchange.clear(!0)):g.refresh(function(a){a?g.canApprove("resource")||(defaultSelection=[{field:"approved",values:[{qText:"True"}]}]):defaultSelection=[{field:"approved",values:[{qText:"True"}]}],searchExchange.subscribe("reset","resources",function(){searchExchange.init(defaultSelection),searchExchange.unsubscribe("reset","resources")}),h.name.split(".")[0]==b.name.split(".")[0]&&"loginsignup"!=h.name||searchExchange.clear(!0)})})}]),app.controller("commentController",["$sce","$scope","$resource","$state","$stateParams","userManager","resultHandler",function(a,b,c,d,e,f,g){function h(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;e<d;e++)b+=String.fromCharCode(c[e]);return b}function i(a){var b=a.replace(/<img[^>]*>/g,"[image]");return noHTML=b.replace(/<\/?[^>]+(>|$)/g,""),noHTML}var j=c("api/comment/:commentId",{commentId:"@commentId"});c("api/"+b.entity+"/"+b.entityid+"/:path",{path:"@path"});b.userManager=f,b.simplemde=new SimpleMDE({element:$("#commentContent")[0],placeholder:"Post a comment here."}),b.comments=[],b.pageSize=10,b.sortOptions={newest:{id:"newest",name:"Newest",order:-1,field:"createdate"},oldest:{id:"oldest",name:"Oldest",order:1,field:"createdate"}},b.getFlagged=function(){j.get({commentId:"flagged",entityId:b.entityid},{limit:100},function(a){if(g.process(a)&&a.data)for(var c=0;c<a.data.length;c++)b.flagged[a.data[c].entityId]=!0})},b.getFlagged(),b.isFlagged=function(a){if(b.flagged){for(var c=0;c<b.flagged.length;c++)if(b.flagged[c].entityId==a)return!0;return!1}return!1},b.commentQuery={limit:b.pageSize},b.applySort=function(a){b.commentQuery.sort=a.field,b.commentQuery.sortOrder=a.order,b.getCommentData(b.commentQuery)},b.sort=b.sortOptions.newest,b.commentQuery.sort=b.sort.field,b.commentQuery.sortOrder=b.sort.order,b.$on("listItemDeleted",function(a,c){for(var d=0;d<b.comments.length;d++)b.comments[d]._id==c&&b.comments.splice(d,1)}),b.getCommentData=function(a,c){j.get(a,function(a){g.process(a,null,!0)&&(c&&1==c?b.comments=b.comments.concat(a.data):b.comments=a.data,b.commentInfo=a,delete b.commentInfo.data)})},b.entityid&&(b.commentQuery.entityId=b.entityid,b.url=b.entity+"/"+b.entityId,b.getCommentData(b.commentQuery)),b.getCommentText=function(b){if(b&&b.data){var c=h(b.data),d=marked(c);return a.trustAsHtml(d)}return""},b.saveComment=function(){var a=b.simplemde.value(),c={standard:{entityId:b.entityid,entity:b.entity,content:a,plaintext:i(a)},special:{content:a}};j.save({},c,function(a){g.process(a)&&(b.simplemde.value(""),b.getCommentData(b.commentQuery))})},b.more=function(){b.commentQuery.skip=b.comments.length,b.getCommentData(b.commentQuery,!0)}}]),app.controller("userController",["$rootScope","$scope","$resource","$state","$stateParams","userManager","resultHandler","notifications",function(a,b,c,d,e,f,g,h){var i=c("api/userprofile/:userId",{userId:"@userId"}),j=c("api/userrole/:roleId",{roleId:"@roleId"}),k=c("api/project/:projectId",{projectId:"@projectId"}),l=c("auth/change");b.query={},b.projectCount=0,b.userLoading=!0,b.userManager=f;var m=[];j.get({},function(a){g.process(a)&&(b.roles=a.data,b.roleInfo=a,delete b.roleInfo.data)}),e.userId&&(b.query.userId=e.userId,k.get({projectId:"count",userid:e.userId},function(a){g.process(a)&&(b.projectCount=a.count)})),b.changePassword=function(){l.save({oldPassword:b.oldpassword,password:b.password},function(a){g.process(a)?(b.oldpassword="",b.password="",b.confirm="",h.notify("Your password was successfully changed. ",null,{sentiment:"positive"})):h.notify(a.errText,null,{sentiment:"negative"})})},b.getUserData=function(c,d){i.get(c,function(c){b.userLoading=!1,g.process(c)&&(d&&1==d?b.users=b.users.concat(c.data):b.users=c.data,b.userInfo=c,console.log(c.data),a.headTitle=c.data[0].username+" : Qlik Branch Users",a.metaKeys="Branch, Qlik Branch, Qlik Sense, Qlik, Open Source, Github, Projects, Extensions, Mash-ups, API, QAP, Qlik Analytics Platform",a.metaDesc="Qlik Branch integrates with Github to host open source projects leveraging Qlik's extensibility and APIs.  Find code to use as a foundation for your next project, share your work, or get inspired.",a.metaImage="http://branch.qlik.com/resources/branch_logo.png",delete b.userInfo.data)})},b.activeTab=0,b.firstLoad=!0,b.setTab=function(a){b.activeTab=a,b.firstLoad||searchExchange.clear()},b.$on("$stateChangeSuccess",function(a,c,d,g,h){g.name.split(".")[0]==c.name.split(".")[0]&&1==c.name.split(".").length&&searchExchange.publish("executeSearch"),"loginsignup"!=c.name&&(searchExchange.view=c.name.split(".")[0]),g.name.split(".")[0]==c.name.split(".")[0]&&"loginsignup"!=g.name||searchExchange.clear(!0),m=[],"users"==c.name||"users.detail"==c.name?(f.refresh(function(a){a?f.canApprove("project")||f.userInfo._id==e.userId||m.push({field:"approved",values:[{qText:"True"}]}):m.push({field:"approved",values:[{qText:"True"}]}),m.push({field:"userId",values:[{qText:e.userId}]}),searchExchange.subscribe("reset","users",function(){searchExchange.init(m),searchExchange.unsubscribe("reset","users")}),b.firstLoad=!1}),b.getUserData(b.query)):"users.addedit"!=c.name&&"userprofiles.addedit"!=c.name||f.refresh(function(a){a?"new"!=e.userId&&b.getUserData(b.query):window.location="#!login?url=user/"+e.userId+"/edit"})}),b.previewThumbnail=function(){b.dirtyThumbnail=!0;var a=$("#userImage")[0].files[0],c=a.name,d=a.type,e=new FileReader;e.onloadend=function(a){var f=document.createElement("canvas"),g=f.getContext("2d"),h=document.createElement("canvas"),i=h.getContext("2d"),j=new Image;j.onload=function(){var a=j.width,e=j.height;f.width=a,f.height=e,h.width=a*(77/e),h.height=77,g.drawImage(j,0,0,f.width,f.height),b.image={type:d,name:c,data:f.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},i.drawImage(j,0,0,h.width,h.height),b.thumbnail={type:d,name:c,data:h.toDataURL("image/png").replace(/^data:image\/(png|jpg);base64,/,"")},b.$apply(function(){b.users[0].thumbnail=h.toDataURL()})},j.src=e.result},e.readAsDataURL(a)},b.validateNewUserData=function(){var a=[];b.users[0].fullname&&""!=b.users[0].fullname||a.push("Please tell us your name"),null!=b.users[0].unsubscribed&&""!==b.users[0].unsubscribed||a.push("Please check out the Marketing section"),a.length>0?(h.notify("The user could not be saved. Please review the following...",a,{sentiment:"warning"}),window.scrollTo(100,0)):b.saveUser()},b.getWebsite=function(a){return a.startsWith("http")?a:"http://"+a},b.saveUser=function(){b.userLoading=!0;var a={standard:b.users[0]};b.dirtyThumbnail&&(a.special={image:b.image,thumbnail:b.thumbnail});var c={};b.users[0]._id&&(c.userId=b.users[0]._id),i.save(c,a,function(a){if(b.userLoading=!1,g.process(a)){var c=b.isNew?"created":"updated";window.location="#!user/"+a._id+"?status="+c}else h.notify(a.errText,null,{sentiment:"negative"})})}}]),app.controller("moderationController",["$scope","$rootScope","$resource","$state","$stateParams","userManager","resultHandler","confirm",function(a,b,c,d,e,f,g,h,i){function j(a){if(a.data){for(var b=a.data,c="",d=new Uint8Array(b),e=d.byteLength,f=0;f<e;f++)c+=String.fromCharCode(d[f]);return c}return a}var k=c("/api/"+a.entity+"/:entityId/:function",{entityId:"@entityId","function":"@function"}),l=c("/git/updatereadme/:projectId",{projectId:"@projectId"}),m=c("api/comment/:commentId",{commentId:"@commentId"});a.userManager=f,a.isEditing=!1,a.simplemde,a.isApproved=function(){return"True"==a.approved||1==a.approved},a.flagEntity=function(b){h.prompt("Please provide a comment for this action.",{requireComment:!0,options:["Ok","Cancel"]},function(c){var d=1==a.flagged?"unflag":"flag";0==c.result&&k.save({entityId:a.entityid,"function":d},{comment:c.comment,flagType:b},function(b){g.process(b)&&(a.flagged=!a.flagged)})})},a.hideEntity=function(){h.prompt("Please enter a reason for unapproving the item. An email will be sent to the owner so try not to be too harsh.",{requireComment:!0,options:["Send","Cancel"]},function(b){0==b.result&&k.save({entityId:a.entityid,"function":"hide",hideComment:b.comment},function(b){g.process(b)&&(a.approved="False")})})},a.approveEntity=function(){k.save({entityId:a.entityid,"function":"approve"},function(b){g.process(b)&&(a.approved="True")})},a.editEntity=function(){if("comment"===a.entity){var b=$("<textarea></textarea>");b.text(j(a.entityObject.content)),$("#comment-"+a.entityid).empty().append(b),a.simplemde=new SimpleMDE({element:b[0]}),a.isEditing=!0}else window.location="#!"+a.entity+"/"+a.entityid+"/edit"},a.saveEntity=function(){a.entityObject.content=a.simplemde.value();var b={standard:{content:a.entityObject.content}};m.save({commentId:a.entityid},b,function(b){$("#comment-"+a.entityid).empty().html(marked(a.entityObject.content)),a.isEditing=!1})},a.updateReadme=function(){l.get({projectId:a.entityid},function(a){g.process(a)&&window.location.reload()})},a.deleteEntity=function(){h.prompt("Are you sure you want to delete the selected item?",{options:["Yes","No"]},function(c){0==c.result&&k["delete"]({entityId:a.entityid},function(c){g.process(c)&&("comment"!=a.entity&&(window.location="#!"+a.entity),b.$broadcast("listItemDeleted",a.entityid))})})},f.hasUser()?a.hasUser=!0:f.refresh(function(b){b?a.hasUser=!0:a.hasUser=!1})}]);